<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>pAIrStudio</title>
    
    <!-- Favicons (use project logo at multiple sizes for clearer tab icon) -->
    <link rel="icon" type="image/png" sizes="64x64" href="assets/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/logo.png">
    <meta name="theme-color" content="#461d7c">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Project styles extracted to external file -->
    <link rel="stylesheet" href="/src/styles.css">
</head>

<body>
    <!-- Consent Modal Overlay -->
    <div class="consent-overlay" id="consent-overlay">
        <div class="consent-modal">
            <div class="consent-header">
                <img src="assets/logo.png" alt="pAIrStudio Logo" class="consent-logo" />
                <h1 class="consent-title">Research Study Consent</h1>
                <p class="consent-subtitle">pAIrStudio Warehouse Robot Programming Experiment</p>
            </div>
            
            <div class="consent-body">
                <div class="consent-section">
                    <h3>Study Purpose</h3>
                    <p>This experiment evaluates educational programming tools and their effectiveness in teaching computational thinking skills through robot control.</p>
                </div>
                
                <div class="consent-section">
                    <h3>What You'll Do</h3>
                    <p>You will complete programming challenges using visual block-based coding to control a warehouse robot. This typically takes 15-25 minutes.</p>
                </div>
                
                <div class="consent-section">
                    <h3>Experimental Groups</h3>
                    <p>You may be randomly assigned to one of several groups with different features (such as AI assistance). Group assignment is automatic and anonymous.</p>
                </div>
                
                <div class="consent-section">
                    <h3>Data Collection & Privacy</h3>
                    <p>We collect anonymous interaction data including: code blocks used, completion times, and performance metrics. Your data is identified only by a randomly generated participant ID. No personally identifiable information is collected.</p>
                </div>
                
                <div class="consent-section">
                    <h3>Voluntary Participation</h3>
                    <p>Participation is voluntary. You may close the browser at any time to withdraw.</p>
                </div>
                
                <div class="consent-section" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="color: #856404; font-size: 16px; margin-bottom: 8px;">
                        <i class="fas fa-info-circle"></i> Technical Requirements
                    </h3>
                    <p style="color: #856404; margin: 0; font-size: 14px;">
                        <strong>Internet Connection:</strong> A stable internet connection is required throughout the study to save your progress and data.<br>
                        <strong>Cookies & Local Storage:</strong> By clicking "Accept and Continue," you consent to this site using cookies and browser local storage to enhance your experience and preserve your session data.
                    </p>
                </div>
                
                <div class="consent-checkbox-container">
                    <input type="checkbox" id="consent-checkbox" class="consent-checkbox">
                    <label for="consent-checkbox" class="consent-checkbox-label">
                        I confirm that I am 18 years of age or older, I have read and understood the information above, and I voluntarily consent to participate in this research study.
                    </label>
                </div>
                
                <button class="consent-button" id="consent-button" disabled>
                    <i class="fas fa-check-circle"></i> Accept and Continue
                </button>
            </div>
            
            <div class="consent-footer">
                pAIrStudio Research Platform ‚Ä¢ Contact: ephife3@lsu.edu
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="lsu-header">
        <nav class="navbar navbar-expand-lg lsu-navbar">
            <div class="container-fluid page-container">
                <a class="navbar-brand" href="#">
                    <span class="brand-text">p<span class="highlight-ai">AI</span>rStudio</span>
                </a>
                
                <!-- Level Progress Indicator -->
                <div class="level-progress level-progress-center" id="level-progress-container">
                    <!-- Level indicators will be generated dynamically by LevelManager -->
                </div>
                
                <div class="d-flex align-items-center gap-3">
                    <span class="version-badge">PS v1.0</span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Offline Notification Banner -->
    <div class="offline-notification" id="offline-notification" style="display: none;">
        <div class="offline-notification-content">
            <i class="fas fa-wifi-slash"></i>
            <span class="offline-message">
                <strong>No Internet Connection</strong> - Please connect to the internet. Your progress is being saved locally and will sync when connection is restored.
            </span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container main-container-inline">
        <div class="container-fluid page-container">
            <!-- Instructions Banner -->
            <div class="instructions-banner" id="instructions-banner">
                <div class="instructions-title">
                    <i class="fas fa-info-circle"></i>
                    <span id="instructions-title-text">Level Instructions</span>
                </div>
                <div class="instructions-text" id="instructions-text">
                    Loading instructions...
                </div>
            </div>

            <!-- Workspace -->
            <div class="workspace-container">
                <!-- Game Panel -->
                <div class="panel game-panel">
                    <div class="panel-header">
                        <span><i class="fas fa-gamepad icon"></i>Simulation Viewer</span>
                        <button class="action-btn reset-btn btn-compact" id="reset-btn">
                            <i class="fas fa-redo"></i>
                            Reset Level
                        </button>
                    </div>
                    <div class="panel-body">
                        <!-- Game Canvas -->
                        <div class="game-canvas" id="game-canvas">
                            <!-- Phaser will inject here -->
                        </div>
                    </div>
                </div>

                <!-- Blockly Panel -->
                <div class="panel blockly-panel">
                    <div class="panel-header">
                        <span><i class="fas fa-puzzle-piece icon"></i>Visual Programming</span>
                        <button class="action-btn run-btn btn-compact" id="run-code-btn">
                            <i class="fas fa-play"></i>
                            Run Code
                        </button>
                    </div>
                    <div class="panel-body">
                        <!-- Blockly Workspace -->
                        <div class="blockly-workspace" id="blockly-workspace" style="position: relative;">
                            <div class="blockly-placeholder">
                                <div class="text-center">
                                    <i class="fas fa-puzzle-piece fa-3x mb-3"></i>
                                    <div>Blockly will load here</div>
                                    <small>Visual programming interface</small>
                                </div>
                            </div>
                            <!-- Lock overlay (shown when AI is driving in pair programming mode) -->
                            <div class="blockly-lock-overlay" id="blockly-lock-overlay" style="display: none;">
                                <div class="lock-message">
                                    <i class="fas fa-lock"></i>
                                    <h3>AI is Driving</h3>
                                    <p>The AI will write the code. You can chat to provide guidance.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="result-modal-overlay" id="result-modal">
        <div class="result-modal">
            <div class="result-modal-header" id="result-modal-header">
                <div class="result-icon" id="result-icon">üéâ</div>
                <h2 class="result-title" id="result-title">Level Complete!</h2>
            </div>
            <div class="result-modal-body">
                <p class="result-message" id="result-message">
                    Great job! You successfully completed the level.
                </p>
                <div class="result-buttons" id="result-buttons">
                    <!-- Buttons will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Role Badge (for pair programming groups) -->
    <div id="role-badge" style="display: none;">
        <!-- Content will be dynamically inserted by RoleManager -->
    </div>

    <!-- Draggable Chatbot -->
    <div class="chatbot-container" id="chatbot" style="display: none;">
        <div class="chatbot-header" id="chatbot-header">
            <div class="chatbot-title">
                <span>p<span class="highlight-ai-glow">AI</span>r Assistant</span>
            </div>
            <div class="chatbot-controls">
                <button class="chatbot-btn" id="toggle-chat-btn" title="Minimize">
                    <i class="fas fa-minus" id="toggle-icon"></i>
                </button>
            </div>
        </div>
        
        <div class="chatbot-messages" id="chat-messages">
            <!-- Messages will be added dynamically -->
        </div>
        
        <div class="chatbot-input-container">
            <input 
                type="text" 
                class="chatbot-input" 
                id="chat-input" 
                placeholder="Ask me anything about the level..."
            >
            <button class="chatbot-send" id="chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <!-- Phaser Script (Bundle managed) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/phaser@3.90.0/dist/phaser.min.js"></script> -->
    
    <!-- TODO: Add Blockly when ready -->
    <!-- <script src="https://unpkg.com/blockly/blockly.min.js"></script> -->
    
    <!-- App Entry Point -->
    <script type="module" src="/src/main.js"></script>
    
    <!-- Experiment Manager Initialization -->
    <script type="module">
        import { experimentManager } from '/src/experiment/ExperimentManager.js';
        import { chatbotManager } from '/src/chatbot/ChatbotManager.js';
        import { roleManager } from '/src/chatbot/RoleManager.js';
        
        // Function to initialize chatbot and role managers
        function initializeChatbotSystem() {
            if (!experimentManager.groupId) {
                console.log('‚ö†Ô∏è No group assigned - skipping chatbot initialization');
                return;
            }
            
            console.log(`üìä Initializing for group: ${experimentManager.groupId}`);
            
            // Initialize Role Manager (for pair programming)
            roleManager.initialize(experimentManager);
            
            // Initialize Chatbot Manager
            chatbotManager.initialize(experimentManager, roleManager);
            
            // Connect RoleManager to ChatbotManager for role switch notifications
            roleManager.onRoleChange((newRole) => {
                chatbotManager.onRoleChange(newRole);
            });
            
            console.log('‚úÖ Chatbot system initialized');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('%cüêÖ pAIrStudio v1.0', 'font-size: 24px; color: #fdd023; font-weight: bold;');
            console.log('%cWarehouse Robot Simulation Platform', 'color: #5a2ca0;');
            
            // Initialize experiment manager
            experimentManager.initialize();
            
            // Check if user has already consented
            const hasConsented = experimentManager.getCookie('pair_consented');
            const consentOverlay = document.getElementById('consent-overlay');
            const consentCheckbox = document.getElementById('consent-checkbox');
            const consentButton = document.getElementById('consent-button');
            
            if (hasConsented === 'true' && experimentManager.groupId) {
                // User has already consented and has a group assignment
                consentOverlay.classList.add('hidden');
                console.log(`Returning user in group: ${experimentManager.groupId}`);
                
                // Initialize DataLogger for returning user
                if (window.dataLogger) {
                    window.dataLogger.initExperiment().then(() => {
                        window.dataLogger.setParticipantId(
                            experimentManager.participantId, 
                            experimentManager.groupId
                        );
                        console.log('DataLogger: Initialized for returning user');
                    }).catch(err => {
                        console.error('DataLogger: Initialization failed:', err);
                    });
                }
                
                // Set level progression based on assigned group
                if (window.LevelManager) {
                    window.LevelManager.setLevelProgression(experimentManager.groupId);
                    console.log(`üìö Level progression configured for ${experimentManager.groupId}`);
                }
                
                // Initialize chatbot system if this group has chatbot support
                if (experimentManager.hasFeature('chatbot')) {
                    initializeChatbotSystem();
                }
            } else {
                // Show consent screen
                consentOverlay.classList.remove('hidden');
                
                // Enable/disable button based on checkbox
                consentCheckbox.addEventListener('change', function() {
                    consentButton.disabled = !this.checked;
                });
                
                // Handle consent button click
                consentButton.addEventListener('click', function() {
                    if (!consentCheckbox.checked) return;
                    
                    // Check internet connection immediately
                    if (!navigator.onLine) {
                        // Show offline notification immediately
                        const banner = document.getElementById('offline-notification');
                        if (banner) {
                            banner.style.display = 'block';
                            document.body.classList.add('offline-mode');
                        }
                        
                        // Alert user
                        alert('‚ö†Ô∏è No Internet Connection\n\nPlease connect to the internet before continuing. Your progress requires an active connection to be saved.');
                        return; // Don't proceed with consent
                    }
                    
                    // Disable button and show loading state
                    consentButton.disabled = true;
                    consentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    
                    // Don't assign group yet - wait for first experimental level
                    // Assign experimental group on consent
                    const assignedGroup = experimentManager.assignGroup();
                    
                    // Save consent
                    experimentManager.setCookie('pair_consented', 'true', 365);
                    
                    console.log('‚úÖ Consent accepted');
                    console.log(`üë§ Participant ID: ${experimentManager.participantId}`);
                    console.log(`üìä Assigned to group: ${assignedGroup}`);
                    
                    // Set level progression based on assigned group
                    if (window.LevelManager) {
                        window.LevelManager.setLevelProgression(assignedGroup);
                        console.log(`üìö Level progression configured for ${assignedGroup}`);
                    }
                    
                    // Initialize chatbot system if needed for this group
                    if (experimentManager.hasFeature('chatbot')) {
                        roleManager.initialize(experimentManager);
                        chatbotManager.initialize(experimentManager, roleManager);
                        console.log('‚úÖ Chatbot system initialized for group with chatbot support');
                    }
                    
                    // Hide consent screen with animation
                    setTimeout(() => {
                        consentOverlay.style.opacity = '0';
                        consentOverlay.style.transition = 'opacity 0.5s ease-out';
                        
                        setTimeout(() => {
                            consentOverlay.classList.add('hidden');
                            consentOverlay.style.opacity = '1';
                        }, 500);
                    }, 500);
                });
            }
        });
    </script>
    
    <script>
        // Log basic info
        console.log('%cüêÖ pAIrStudio v1.0', 'font-size: 24px; color: #fdd023; font-weight: bold;');
        console.log('%cLSU Warehouse Robot Simulation Platform', 'color: #5a2ca0;');
        
        // Result Modal Functions
        window.showResultModal = function(isWin, currentLevel) {
            const modal = document.getElementById('result-modal');
            const header = document.getElementById('result-modal-header');
            const icon = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            const message = document.getElementById('result-message');
            const buttons = document.getElementById('result-buttons');

            // Update header style
            header.className = 'result-modal-header ' + (isWin ? 'win' : 'lose');

            // Update content based on win/lose
            if (isWin) {
                icon.textContent = 'üéâ';
                title.textContent = 'Level Complete!';
                message.textContent = 'Congratulations! You successfully completed the level and delivered the box to the goal.';
            } else {
                icon.textContent = '‚ùå';
                title.textContent = 'Level Failed';
                message.textContent = 'The box was dropped in the wrong location. Try again!';
            }

            // Clear and add appropriate buttons
            buttons.innerHTML = '';

            if (isWin) {
                // Check if there's a next level
                const levelManager = window.LevelManager;
                if (levelManager) {
                    const currentIndex = levelManager.allLevelIds.indexOf(currentLevel);
                    const hasNextLevel = currentIndex >= 0 && currentIndex < levelManager.allLevelIds.length - 1;
                    
                    if (hasNextLevel) {
                        // Show Next Level button
                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'result-btn result-btn-next';
                        nextBtn.innerHTML = '<i class=\"fas fa-arrow-right\"></i> Next Level';
                        nextBtn.onclick = function() {
                            modal.classList.remove('show');
                            if (window.GameAPI) {
                                window.GameAPI.nextLevel();
                            }
                        };
                        buttons.appendChild(nextBtn);
                    }
                }
                
                // Also add retry button for wins
                const retryBtn = document.createElement('button');
                retryBtn.className = 'result-btn result-btn-retry';
                retryBtn.innerHTML = '<i class=\"fas fa-redo\"></i> Try Again';
                retryBtn.onclick = function() {
                    modal.classList.remove('show');
                    if (window.GameAPI) {
                        window.GameAPI.resetLevel();
                    }
                };
                buttons.appendChild(retryBtn);
            } else {
                // Show Retry button for losses
                const retryBtn = document.createElement('button');
                retryBtn.className = 'result-btn result-btn-retry';
                retryBtn.innerHTML = '<i class=\"fas fa-redo\"></i> Start Over';
                retryBtn.onclick = function() {
                    modal.classList.remove('show');
                    if (window.GameAPI) {
                        window.GameAPI.resetLevel();
                    }
                };
                buttons.appendChild(retryBtn);
            }

            // Show modal
            modal.classList.add('show');
        };
    </script>
</body>
</html>
